<script>
  /*
   * richard_wagner_script.html
   * 共通JS: リヒャルト・ワーグナー／リヒャルト・シュトラウス「曲名から検索」ページで
   * オペラ選択・検索方法切り替え・場面データ取得・検索実行を担当。
   */

  const sceneOptionsCache = {};
  let currentSearchId = 0;

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('input[name="opera"]').forEach(radio => {
      radio.addEventListener('change', handleOperaSelection);
    });
    document.querySelectorAll('input[name="search-type"]').forEach(radio => {
      radio.addEventListener('change', handleSearchTypeSelection);
    });
  });

  /**
   * オペラ（曲名）が選択されたときの処理
   */
  function handleOperaSelection(event) {
    const operaValue = event.target.value;
    const composer = document.title.includes('Wagner') ? 'richard_wagner' : 'richard_strauss';

    // 検索方法セクションを表示し初期化
    document.getElementById('search-method-container').style.display = 'block';
    resetSearchType();

    const sceneOptionsWrapper = document.getElementById('scene-options-wrapper');
    sceneOptionsWrapper.innerHTML = '<p class="loading">場面データを読み込み中...</p>';

    // キャッシュ済みであればそれを利用
    if (sceneOptionsCache[composer]) {
      buildSceneCheckboxes(operaValue, sceneOptionsCache[composer]);
      return;
    }

    // サーバーから場面データを取得
    google.script.run
      .withSuccessHandler(options => {
        sceneOptionsCache[composer] = options || {};
        buildSceneCheckboxes(operaValue, sceneOptionsCache[composer]);
      })
      .withFailureHandler(err => {
        console.error('場面データの取得に失敗しました', err);
        sceneOptionsWrapper.innerHTML = '<p class="result-message">場面データの取得に失敗しました</p>';
      })
      .getSceneOptionsForOpera(composer);
  }

  /**
   * 取得した場面データをもとにチェックボックス群を描画
   */
  function buildSceneCheckboxes(operaValue, sceneOptionsData) {
    const wrapper = document.getElementById('scene-options-wrapper');
    wrapper.innerHTML = '';
    const options = sceneOptionsData[operaValue];

    if (!options || options.length === 0) {
      wrapper.innerHTML = '<p>この曲の場面データは登録されていません。</p>';
      return;
    }

    const checkboxGroup = document.createElement('div');
    checkboxGroup.className = 'checkbox-group';

    // 「すべて」チェックボックス
    checkboxGroup.innerHTML += `<label><input type="checkbox" name="${operaValue}-scene" value="all"> すべて</label>`;
    if (options.length > 1) {
      checkboxGroup.innerHTML += '<hr>';
    }

    options.forEach(opt => {
      checkboxGroup.innerHTML += `<label><input type="checkbox" name="${operaValue}-scene" value="${opt.value}"> ${opt.text}</label>`;
    });

    wrapper.appendChild(checkboxGroup);

    // 「すべて」チェックボックスの排他制御
    const sceneCheckboxes = wrapper.querySelectorAll(`input[name="${operaValue}-scene"]`);
    if (sceneCheckboxes.length > 1) {
      const allCheckbox = wrapper.querySelector(`input[name="${operaValue}-scene"][value="all"]`);
      sceneCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          if (cb.value === 'all' && cb.checked) {
            sceneCheckboxes.forEach(other => {
              if (other.value !== 'all') other.checked = false;
            });
          } else if (cb.value !== 'all' && cb.checked && allCheckbox) {
            allCheckbox.checked = false;
          }
        });
      });
    }
  }

  /**
   * 検索方法（場面 / ページ）が選択されたときの処理
   */
  function handleSearchTypeSelection(event) {
    const type = event.target.value;
    document.getElementById('scene-selection-container').style.display = type === 'scene' ? 'block' : 'none';
    document.getElementById('page-selection-container').style.display = type === 'page' ? 'block' : 'none';
  }

  /**
   * 検索方法の選択状態をリセット
   */
  function resetSearchType() {
    document.querySelectorAll('input[name="search-type"]').forEach(radio => (radio.checked = false));
    document.getElementById('scene-selection-container').style.display = 'none';
    document.getElementById('page-selection-container').style.display = 'none';
    setResults('');
  }

  /**
   * 場面で検索
   */
  function searchByScene() {
    const selectedOpera = document.querySelector('input[name="opera"]:checked');
    if (!selectedOpera) {
      setResults('<p class="result-message">曲を選択してください</p>');
      return;
    }

    document.querySelectorAll('#scene-selection-container .btn-search').forEach(btn => {
      btn.disabled = true;
    });

    const operaValue = selectedOpera.value;
    const sceneCheckboxes = document.querySelectorAll(`input[name="${operaValue}-scene"]:checked`);
    const selectedScenes = Array.from(sceneCheckboxes).map(cb => cb.value);
    if (selectedScenes.length === 0) {
      setResults('<p class="result-message">場面を選択してください</p>');
      document.querySelectorAll('#scene-selection-container .btn-search').forEach(btn => {
        btn.disabled = false;
      });
      return;
    }

    setResults('<p class="loading">検索中・・・</p>');
    currentSearchId++;
    const thisSearchId = currentSearchId;

    const funcName = document.title.includes('Wagner')
      ? 'searchRichardWagnerByScene'
      : 'searchRichardStraussByScene';

    google.script.run
      .withSuccessHandler(html => {
        if (thisSearchId === currentSearchId) setResults(html);
        document.querySelectorAll('#scene-selection-container .btn-search').forEach(btn => {
          btn.disabled = false;
        });
      })
      .withFailureHandler(err => {
        if (thisSearchId === currentSearchId) {
          setResults(`<p class="result-message">検索に失敗しました: ${err.message}</p>`);
        }
        document.querySelectorAll('#scene-selection-container .btn-search').forEach(btn => {
          btn.disabled = false;
        });
      })[funcName](operaValue, selectedScenes);
  }

  /**
   * ページ番号で検索
   */
  function searchByPage() {
    const selectedOpera = document.querySelector('input[name="opera"]:checked');
    if (!selectedOpera) {
      setResults('<p class="result-message">曲を選択してください</p>');
      return;
    }

    document.querySelectorAll('#page-selection-container .btn-search').forEach(btn => {
      btn.disabled = true;
    });

    const operaValue = selectedOpera.value;
    const pageInput = document.getElementById('page-input').value.trim();
    if (!pageInput) {
      setResults('<p class="result-message">ページ番号を入力してください</p>');
      document.querySelectorAll('#page-selection-container .btn-search').forEach(btn => {
        btn.disabled = false;
      });
      return;
    }

    setResults('<p class="loading">検索中・・・</p>');
    currentSearchId++;
    const thisSearchId = currentSearchId;

    const funcName = document.title.includes('Wagner')
      ? 'searchRichardWagnerByPage'
      : 'searchRichardStraussByPage';

    google.script.run
      .withSuccessHandler(html => {
        if (thisSearchId === currentSearchId) setResults(html);
        document.querySelectorAll('#page-selection-container .btn-search').forEach(btn => {
          btn.disabled = false;
        });
      })
      .withFailureHandler(err => {
        if (thisSearchId === currentSearchId) {
          setResults(`<p class="result-message">検索に失敗しました: ${err.message}</p>`);
        }
        document.querySelectorAll('#page-selection-container .btn-search').forEach(btn => {
          btn.disabled = false;
        });
      })[funcName](operaValue, pageInput);
  }

  /**
   * 検索を中止
   */
  function cancelSearch() {
    currentSearchId++;
    setResults('<p class="loading">検索を中止しました</p>');
    document.querySelectorAll('.btn-search').forEach(btn => (btn.disabled = false));
  }

  function clearScenes() {
    const selectedOpera = document.querySelector('input[name="opera"]:checked');
    if (!selectedOpera) return;
    const operaValue = selectedOpera.value;
    document.querySelectorAll(`input[name="${operaValue}-scene"]`).forEach(cb => {
      cb.checked = false;
    });
    setResults('');
  }

  function clearPageInput() {
    document.getElementById('page-input').value = '';
    setResults('');
  }
</script>

